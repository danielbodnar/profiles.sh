---
import { PERSONA_COLORS } from "../styles/tokens";

interface PersonaRef {
  id: string;
  shortTitle: string;
  accent: string;
}

interface Props {
  name: string;
  description: string;
  url?: string;
  tech: string[];
  personaMap: string[];
  personas: PersonaRef[];
}

const { name, description, url, tech, personaMap, personas } = Astro.props;

const stripeColors = personaMap
  .map((pid) => {
    const p = PERSONA_COLORS[pid];
    return p ? p.accent : null;
  })
  .filter(Boolean) as string[];

const personaLegend = personaMap
  .map((pid) => {
    const found = personas.find((p) => p.id === pid);
    return found ? { id: pid, title: found.shortTitle, accent: found.accent } : null;
  })
  .filter(Boolean) as { id: string; title: string; accent: string }[];
---
<div class="modal-overlay" id={`project-modal-${name}`}>
  <div class="project-modal-panel" role="dialog" aria-label={name}>
    <div class="pm-body">
      {/* Left stripe */}
      <div class="pm-stripe">
        {stripeColors.map((c) => (
          <div class="pm-stripe-segment" style={`background:${c};`}></div>
        ))}
      </div>
      <div class="pm-content">
        <div class="pm-header">
          <h3 class="pm-name">{name}</h3>
          <p class="pm-desc">{description}</p>

          {url && (
            <a href={url} target="_blank" rel="noopener noreferrer" class="pm-url">
              {url.replace(/^https?:\/\//, "")} &rarr;
            </a>
          )}

          <div class="pm-section-label">Tech</div>
          <div class="pm-tech">
            {tech.map((t) => (
              <span class="pm-tech-badge">{t}</span>
            ))}
          </div>

          <div class="pm-section-label">Persona Affinity</div>
          <div class="pm-legend">
            {personaLegend.map((pl) => (
              <div class="pm-legend-item">
                <div class="pm-legend-dot" style={`background:${pl.accent};`}></div>
                <span>{pl.title}</span>
              </div>
            ))}
          </div>
        </div>

        <button
          class="pm-close"
          data-modal-close
        >
          &#10005; close
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .project-modal-panel {
    width: 400px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    background: linear-gradient(135deg, #0c0c14 0%, #14141e 100%);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 48px rgba(0, 0, 0, 0.6);
  }

  .pm-body {
    display: flex;
    overflow: hidden;
    border-radius: 16px;
  }

  .pm-stripe {
    width: 6px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .pm-stripe-segment {
    flex: 1;
  }

  .pm-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .pm-header {
    padding: 18px 22px;
  }

  .pm-name {
    margin: 0;
    font-size: 17px;
    font-weight: 700;
    color: #fff;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
  }

  .pm-desc {
    margin: 6px 0 12px;
    font-size: 11px;
    color: #999;
    line-height: 1.4;
  }

  .pm-url {
    display: inline-block;
    font-size: 10px;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
    color: #40c4ff;
    text-decoration: none;
    margin-bottom: 12px;
    padding: 3px 8px;
    background: rgba(64, 196, 255, 0.08);
    border: 1px solid rgba(64, 196, 255, 0.15);
    border-radius: 4px;
    transition: opacity 0.15s;
  }

  .pm-url:hover {
    opacity: 0.8;
  }

  .pm-section-label {
    font-size: 8px;
    color: #555;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 5px;
  }

  .pm-tech {
    line-height: 1.8;
    margin-bottom: 12px;
  }

  .pm-tech-badge {
    display: inline-block;
    font-size: 9px;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
    padding: 2px 6px;
    border-radius: 3px;
    margin-right: 4px;
    margin-bottom: 3px;
    background: rgba(255, 255, 255, 0.06);
    color: #aaa;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .pm-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .pm-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .pm-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .pm-legend-item span {
    font-size: 9px;
    color: #777;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
  }

  .pm-close {
    width: 100%;
    padding: 10px 0;
    text-align: center;
    cursor: pointer;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    border-left: none;
    border-right: none;
    border-bottom: none;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 0 0 16px 0;
    font-size: 10px;
    font-family: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
    color: #555;
    transition: color 0.15s;
  }

  .pm-close:hover {
    color: #aaa;
  }
</style>
